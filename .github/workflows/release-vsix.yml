name: Release VSIX

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Compute release metadata
        id: meta
        run: |
          NAME=$(node -p "require('./packages/vscode-extension/package.json').name")
          VERSION=$(node -p "require('./packages/vscode-extension/package.json').version")
          SHA="${GITHUB_SHA}"
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="vsix-${SHA}"
          RELEASE_NAME="vsix-${SHORT_SHA}"
          VSIX="packages/vscode-extension/${NAME}-${VERSION}.vsix"

          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "release_name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"
          echo "vsix=$VSIX" >> "$GITHUB_OUTPUT"

      - name: Check if release exists
        id: release_check
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.meta.outputs.tag }}'
            try {
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              })
              core.setOutput('exists', 'true')
            } catch (e) {
              if (e.status === 404) {
                core.setOutput('exists', 'false')
                return
              }
              throw e
            }

      - name: Install dependencies
        if: steps.release_check.outputs.exists != 'true'
        run: npm ci

      - name: Build VSIX
        if: steps.release_check.outputs.exists != 'true'
        run: npm run vsix

      - name: Verify VSIX exists
        if: steps.release_check.outputs.exists != 'true'
        run: test -f "${{ steps.meta.outputs.vsix }}"

      - name: Upload workflow artifact
        if: steps.release_check.outputs.exists != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.name }}-${{ steps.meta.outputs.version }}.vsix
          path: ${{ steps.meta.outputs.vsix }}
          if-no-files-found: error

      - name: Create GitHub Release
        if: steps.release_check.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.release_name }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: ${{ steps.meta.outputs.vsix }}
